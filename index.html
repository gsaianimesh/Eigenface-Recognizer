<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eigenface Recognizer</title>
    <!-- Load Tailwind CSS for styling --><script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Use Inter font */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom styles for the file input */
        input[type="file"]::file-selector-button {
            background-color: #3b82f6; /* bg-blue-600 */
            color: white;
            border: 0;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem; /* rounded-md */
            cursor: pointer;
            transition: background-color 0.2s;
        }
        input[type="file"]::file-selector-button:hover {
            background-color: #2563eb; /* bg-blue-700 */
        }
        /* Simple CSS loader */
        .loader {
            border: 4px solid #f3f3f3; /* light grey */
            border-top: 4px solid #3b82f6; /* blue */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center justify-center py-10 px-4">
    <h1 class="text-4xl font-extrabold text-center text-gray-800 mb-10">
        Eigenface Face Recognition System
    </h1>

    <div class="flex flex-col lg:flex-row gap-8 w-full max-w-6xl">
        <!-- Left Column: Recognizer and Add Person --><div class="lg:w-1/2 flex flex-col gap-8">
            <!-- Recognizer Card --><div class="bg-white p-8 rounded-lg shadow-xl">
                <h2 class="text-3xl font-bold text-center text-gray-800 mb-6">
                    Eigenface Face Recognizer
                </h2>
                
                <!-- Upload Section --><div class="mb-6">
                    <label class="block mb-2 text-sm font-medium text-gray-700" for="imageUploader">
                        Upload a face image (jpg, png, pgm):
                    </label>
                    <input type="file" id="imageUploader" accept="image/*"
                           class="block w-full text-sm text-gray-900 bg-gray-50 rounded-lg border border-gray-300 cursor-pointer focus:outline-none">
                </div>
                
                <button id="recognizeButton"
                        class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition duration-300 shadow-md">
                    Recognize Face
                </button>
                
                <!-- Loading Spinner (hidden by default) --><div id="loader" class="loader hidden"></div>
                
                <!-- Error Message --><div id="error" class="hidden mt-4 p-4 bg-red-100 text-red-700 border border-red-300 rounded-lg">
                    <!-- Error content goes here --></div>

                <!-- Results Section (hidden by default) --><div id="results" class="hidden mt-8">
                    <h3 id="resultText" class="text-2xl font-semibold text-center text-green-700 mb-4">
                        <!-- Result: Person (Distance: X) --></h3>
                    
                    <div class="flex flex-col md:flex-row gap-6">
                        <!-- Test Image --><div class="flex-1 text-center">
                            <h4 class="text-lg font-medium text-gray-700 mb-2">Your Image</h4>
                            <img id="testImage" src="" alt="Test Image"
                                 class="w-full h-auto object-cover rounded-lg shadow-md border border-gray-200">
                        </div>
                        
                        <!-- Match Image --><div class="flex-1 text-center">
                            <h4 class="text-lg font-medium text-gray-700 mb-2">Closest Match</h4>
                            <img id="matchImage" src="" alt="Matched Image"
                                 class="w-full h-auto object-cover rounded-lg shadow-md border border-gray-200">
                        </div>
                    </div>

                    <!-- RECOGNITION MATH EXPLANATION --><div class="mt-8 pt-6 border-t border-gray-200">
                        <h4 class="text-xl font-semibold text-gray-800 mb-3 text-center">
                            How This Was Found: The Math
                        </h4>
                        <ol class="list-decimal list-inside space-y-2 text-gray-600">
                            <li>The 100x100 uploaded image was flattened into a single, high-dimensional <strong>vector</strong> (10,000 dimensions).</li>
                            <li>The <strong>"Mean Face" vector</strong> (shown in the visualization below) was subtracted from this image vector.</li>
                            <li>This new "difference" vector was <strong>projected onto the Eigenface subspace</strong>. This is done by taking the <strong>dot product</strong> of the difference vector with each of the top 50 Eigenvectors (Eigenfaces).</li>
                            <li>This projection created a new, very small vector of 50 "weights" (or "coordinates"). This is the face's unique signature in "face space".</li>
                            <li>This 50-number signature was compared to the signatures of all faces in the database by calculating the <strong>Euclidean distance</strong>.</li>
                            <li>The matched image is the one with the <strong>smallest distance</strong> (the `Distance` value shown in the result).</li>
                        </ol>
                    </div>
                    
                </div>
            </div>

            <!-- Add Person Card --><div class="bg-white p-8 rounded-lg shadow-xl">
                <h3 class="text-2xl font-bold text-center text-gray-800 mb-6">
                    Add New Person & Retrain
                </h3>

                <!-- Person Name Input --><div class="mb-6">
                    <label class="block mb-2 text-sm font-medium text-gray-700" for="personName">
                        Person's Name:
                    </label>
                    <input type="text" id="personName"
                           class="block w-full text-sm text-gray-900 bg-gray-50 rounded-lg border border-gray-300 p-2.5 focus:outline-none focus:ring-2 focus:ring-blue-500"
                           placeholder="e.g., John Doe">
                </div>

                <!-- Image Uploader (Multiple) --><div class="mb-6">
                    <label class="block mb-2 text-sm font-medium text-gray-700" for="newImageUploader">
                        Upload images (select multiple):
                    </label>
                    <input type="file" id="newImageUploader" accept="image/*" multiple
                           class="block w-full text-sm text-gray-900 bg-gray-50 rounded-lg border border-gray-300 cursor-pointer focus:outline-none">
                </div>

                <button id="addPersonButton"
                        class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition duration-300 shadow-md">
                    Add Person & Retrain Model
                </button>

                <!-- Loading Spinner --><div id="addLoader" class="loader hidden"></div>

                <!-- Success/Error Message --><div id="addMessage" class="hidden mt-4 p-4 rounded-lg text-center font-medium">
                    <!-- Message content goes here --></div>
            </div>
        </div>

        <!-- Right Column: Model Visualization --><div class="lg:w-1/2 flex flex-col gap-8">
            <div class="bg-white p-8 rounded-lg shadow-xl">
                <h2 class="text-3xl font-bold text-center text-gray-800 mb-4">
                    Project Visualization: <strong>Eigenvectors & Eigenvalues</strong> in Action
                </h2>
                <p class="text-center text-gray-600 mb-6">
                    This section visually demonstrates the core concepts from your <strong>Matrix Math / Linear Algebra</strong> project. We apply <strong>Principal Component Analysis (PCA)</strong> to a dataset of faces. The "Eigenfaces" you'll see are the principal <strong>Eigenvectors</strong> of the face dataset's covariance matrix.
                </p>

                <button id="loadDetailsButton"
                        class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition duration-300 shadow-md">
                    Show Model Internals
                </button>

                <!-- TODO: Replace with your PDF link -->
                <a href="YOUR_PROJECT_REPORT.pdf"
                   target="_blank"
                   rel="noopener noreferrer"
                   class="block w-full bg-gray-700 text-white font-bold py-3 px-4 rounded-lg hover:bg-gray-800 transition duration-300 shadow-md text-center mt-4">
                    View Full Project Report (PDF)
                </a>

                <!-- Loading Spinner --><div id="detailsLoader" class="loader hidden"></div>
                
                <!-- Error Message --><div id="detailsError" class="hidden mt-4 p-4 bg-red-100 text-red-700 border border-red-300 rounded-lg">
                    <!-- Error content goes here --></div>

                <div id="detailsResults" class="hidden mt-8">
                    <!-- Mean Face --><div class="text-center mb-8">
                        <h3 class="text-xl font-semibold text-gray-800 mb-2">1. The "Mean Face" (Data Centering)</h3>
                        <p class="text-gray-600 mb-4">
                            This is the average of all faces in the training dataset. In linear algebra terms, this "mean vector" is calculated and then <strong>subtracted from every face vector</strong>. This process, called <strong>centering the data</strong>, is a crucial first step before calculating the <strong>covariance matrix</strong>.
                        </p>
                        <img id="meanFaceImage" src="" alt="Mean Face"
                             class="w-1/2 h-auto object-cover rounded-lg shadow-md border border-gray-200 mx-auto">
                    </div>

                    <!-- Eigenfaces --><div class="text-center mb-8">
                        <h3 class="text-xl font-semibold text-gray-800 mb-2">2. The "Eigenfaces" (Principal Eigenvectors)</h3>
                        <p class="text-gray-600 mb-4">
                            These are the <strong>Eigenfaces</strong>, which are the principal <strong>Eigenvectors</strong> of the covariance matrix. Each Eigenface (Eigenvector) corresponds to an <strong>Eigenvalue</strong> that indicates how much variance (i.e., importance) it captures. We display the top 5, which have the largest Eigenvalues, as they represent the most significant patterns of variation in the face dataset.
                            <br><br>
                            They look ghostly because they represent abstract features (like lighting direction, forehead shape, nose structure) found across all faces, rather than a specific person.
                        </p>
                        <div id="eigenfacesContainer" class="flex flex-wrap justify-center gap-4">
                            <!-- Eigenfaces will be injected here by JS --></div>
                    </div>

                    <!-- PROJECTION EXPLANATION --><div class="text-center pt-8 border-t border-gray-200">
                        <h3 class="text-xl font-semibold text-gray-800 mb-2">3. The Recognition Process (Projection)</h3>
                        <p class="text-gray-600 mb-4">
                            This connects steps 1 and 2. To recognize a new face, we don't compare all 10,000 pixels. Instead, we perform a <strong>change of basis</strong>:
                            <br><br>
                            We first subtract the Mean Face from the new image to get a "difference" vector. Then, we <strong>project</strong> this difference vector onto the low-dimensional "face space" (the subspace spanned by the Eigenvectors/Eigenfaces). This is achieved by calculating the <strong>dot product</strong> of the difference vector with each of the selected Eigenvectors. This gives us a small set of weights (e.g., 50 numbers) that describe the face. We then find the known face with the closest set of weights using <strong>Euclidean distance</strong>. This is <strong>dramatically faster</strong> and more robust to noise than pixel-by-pixel comparison.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // === Recognizer Elements ===
        const uploader = document.getElementById('imageUploader');
        const button = document.getElementById('recognizeButton');
        const loader = document.getElementById('loader');
        const resultsDiv = document.getElementById('results');
        const errorDiv = document.getElementById('error');
        
        const resultText = document.getElementById('resultText');
        const testImage = document.getElementById('testImage');
        const matchImage = document.getElementById('matchImage');

        // === Add Person Elements ===
        const personNameInput = document.getElementById('personName');
        const newImageUploader = document.getElementById('newImageUploader');
        const addPersonButton = document.getElementById('addPersonButton');
        const addLoader = document.getElementById('addLoader');
        const addMessage = document.getElementById('addMessage');

        // === Model Details Elements ===
        const loadDetailsButton = document.getElementById('loadDetailsButton');
        const detailsLoader = document.getElementById('detailsLoader');
        const detailsError = document.getElementById('detailsError');
        const detailsResults = document.getElementById('detailsResults');
        const meanFaceImage = document.getElementById('meanFaceImage');
        const eigenfacesContainer = document.getElementById('eigenfacesContainer');


        // === Recognizer Logic ===
        button.addEventListener('click', async () => {
            const file = uploader.files[0];
            if (!file) {
                showError("Please select an image file first.");
                return;
            }

            // Hide old results/errors, show loader
            resultsDiv.classList.add('hidden');
            errorDiv.classList.add('hidden');
            loader.classList.remove('hidden');

            // Create a FormData object to send the file
            const formData = new FormData();
            formData.append('image', file);

            try {
                // Send the image to the Flask server
                const response = await fetch('http://127.0.0.1:5000/recognize', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    // Handle server errors (e.g., 400, 500)
                    const errData = await response.json();
                    throw new Error(errData.error || `Server error: ${response.status}`);
                }

                // Get the JSON data from the response
                const data = await response.json();

                // --- Success! Populate the results ---
                
                // Set the text
                resultText.textContent = `Recognized as: ${data.person} (Distance: ${data.distance})`;
                
                // Set the images. We must add the base64 prefix.
                testImage.src = 'data:image/png;base64,' + data.test_image_b64;
                matchImage.src = 'data:image/png;base64,' + data.match_image_b64;
                
                // Hide loader, show results
                loader.classList.add('hidden');
                resultsDiv.classList.remove('hidden');

            } catch (error) {
                // Handle network errors or errors from the server
                console.error("Fetch error:", error);
                showError(`Error: ${error.message}. Is the Python server running?`);
            }
        });
        
        function showError(message) {
            loader.classList.add('hidden');
            resultsDiv.classList.add('hidden');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
        }

        // === Add Person Logic ===
        addPersonButton.addEventListener('click', async () => {
            const name = personNameInput.value.trim();
            const files = newImageUploader.files;

            // --- Validation ---
            if (!name) {
                showAddMessage("Please enter a person's name.", 'error');
                return;
            }
            if (files.length === 0) {
                showAddMessage("Please select one or more images to upload.", 'error');
                return;
            }

            // --- Show loader, hide old message ---
            addLoader.classList.remove('hidden');
            addMessage.classList.add('hidden');

            // --- Create FormData ---
            const formData = new FormData();
            formData.append('personName', name);
            for (const file of files) {
                formData.append('image', file);
            }

            // --- Send to new endpoint ---
            try {
                const response = await fetch('http://127.0.0.1:5000/add_person', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || `Server error: ${response.status}`);
                }

                // --- Success ---
                showAddMessage(data.message, 'success');
                // Clear inputs
                personNameInput.value = '';
                newImageUploader.value = '';

            } catch (error) {
                console.error("Add person error:", error);
                showAddMessage(`Error: ${error.message}`, 'error');
            } finally {
                // Hide loader
                addLoader.classList.add('hidden');
            }
        });

        function showAddMessage(message, type) {
            addMessage.textContent = message;
            
            // Remove old styles
            addMessage.classList.remove('bg-red-100', 'text-red-700', 'border-red-300');
            addMessage.classList.remove('bg-green-100', 'text-green-700', 'border-green-300');

            // Add new styles
            if (type === 'error') {
                addMessage.classList.add('bg-red-100', 'text-red-700', 'border-red-300');
            } else {
                addMessage.classList.add('bg-green-100', 'text-green-700', 'border-green-300');
            }
            
            addMessage.classList.remove('hidden');
        }

        // === Load Model Details Logic ===
        loadDetailsButton.addEventListener('click', async () => {
            // Show loader, hide error/results
            detailsLoader.classList.remove('hidden');
            detailsError.classList.add('hidden');
            detailsResults.classList.add('hidden');
            loadDetailsButton.classList.add('hidden'); // Hide button after click

            try {
                const response = await fetch('http://127.0.0.1:5000/get_model_details', {
                    method: 'GET',
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || `Server error: ${response.status}`);
                }

                // --- Success! Populate the details ---

                // 1. Set Mean Face
                meanFaceImage.src = 'data:image/png;base64,' + data.mean_face_b64;

                // 2. Set Eigenfaces
                eigenfacesContainer.innerHTML = ''; // Clear old ones
                data.eigenfaces_b64.forEach((b64String, index) => {
                    const eigenfaceDiv = document.createElement('div');
                    eigenfaceDiv.classList.add('w-1/3', 'md:w-1/6', 'p-1');
                    eigenfaceDiv.innerHTML = `
                        <img src="data:image/png;base64,${b64String}" alt="Eigenface ${index + 1}" class="w-full h-auto object-cover rounded-lg shadow-md border border-gray-200">
                        <p class="text-sm text-gray-600 mt-1">Eigenface ${index + 1}</p>
                    `;
                    eigenfacesContainer.appendChild(eigenfaceDiv);
                });

                // Show results
                detailsResults.classList.remove('hidden');

            } catch (error) {
                console.error("Load details error:", error);
                showDetailsError(`Error: ${error.message}. Is the Python server running?`);
                loadDetailsButton.classList.remove('hidden'); // Show button again on error
            } finally {
                // Hide loader
                detailsLoader.classList.add('hidden');
            }
        });

        function showDetailsError(message) {
            detailsError.textContent = message;
            detailsError.classList.remove('hidden');
        }

    </script>
</body>
</html>